<!DOCTYPE html>
<html>
  <head>
    <title>Chat Server</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
    <style>
      h1 {
        margin-top:4px;
      }
      div {
        padding:4px;
      }
      a {
        margin:6px;
      }
      .chatDialog {
        display:inline-block;
      }
      .chatBox {
        display:inline-block;
        height:250px;
        width:180px;
        position:relative;
        overflow:hidden;
      }
      .chatLog {
        position:absolute;
        bottom:30px;
        left:0;
        overflow:hidden;
      }
      .chatForm {
        position:absolute;
        bottom:0;
      }
    </style>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx">
      var my_username;
      var socket;

      //TODO: React-y way?
      $(document).ready(function(){
        socket = io.connect();
        socket.on('connect', function(){
          socket.emit('request population');
        });
        socket.on('register population', function(){
          if (my_username) {
            socket.emit('register me', my_username);
          }
        });
      });

      var StaticTop = React.createClass({
        handleSubmit: function(e) {
          e.preventDefault();
          my_username = React.findDOMNode(this.refs.username).value;
          socket.emit('register me', my_username);
        },
        render: function() {
          return (
            <div>
              <h1>Chat Server</h1>
              <form onSubmit={this.handleSubmit}>
                <label>Name: <input type="text" placeholder="username" ref="username" /></label>
              </form>
            </div>
          );
        }
      });

      var Conversation = React.createClass({
        handleSubmit: function(e) {
          e.preventDefault();
          var messageBox = React.findDOMNode(this.refs.message);
          socket.emit('message', {
            from: my_username,
            recipient: this.props.username,
            message: messageBox.value
          });
          messageBox.value = '';
        },
        render: function() {
          return (
            <div className="chatDialog">
              <h4>{this.props.username}</h4>
              <div className="chatBox">
                <div className="chatLog">
                  {this.props.log.map(function (message) {
                    return <p>{message}</p>;
                  })}
                </div>
                <form className="chatForm" onSubmit={this.handleSubmit}>
                  <input type="text" placeholder="message" ref="message" />
                </form>
              </div>
            </div>
          );
        }
      });

      var Population = React.createClass({
        getInitialState: function() {
          return {users: []};
        },
        componentDidMount: function() {
          //TODO is this the right spot for this?
          //TODO eliminate dups and self
          socket.on('register one', function(username) {  console.log('a');
            this.setState({users: this.state.users.concat([username]).sort()}); console.log('b');
          }.bind(this));
        },
        render: function() {
          return (
            <div>
              {this.state.users.map(function(username) {
                return <a href="#" onClick={function(){this.props.openConversation(username)}.bind(this)}>{username}</a>;
              }.bind(this))}
            </div>
          );
        }
      });

      var Conversations = React.createClass({
        // state is map from friend username => list of messages
        getInitialState: function() {
          return {};
        },
        componentDidMount: function() {
          socket.on('message', function(data) {
            this.setState(function(previousState, props) { //must be a better way to do this stuff
              var update = {};
              var msgString = data.from + ': ' + data.message;
              if (data.recipient == my_username) {
                if (!(data.from in previousState))
                  update[data.from] = [msgString];
                else
                  update[data.from] = previousState[data.from].concat([msgString]);
              } else if (data.from == my_username) {
                update[data.recipient] = previousState[data.recipient].concat([msgString]);
              } else {
                console.log('unsolicited message');
              }
              return update;
            });
          }.bind(this));
        },
        openConversation: function(recipient) {
          this.setState(function(previousState, props) { //better way with the extend framework / use backbone?
            if (recipient in previousState)
              return {};

            var obj = {};
            obj[recipient] = [];
            return obj;
          });
        },
        render: function() {
          return (
            <div>
              <Population openConversation={this.openConversation}/>
              {Object.keys(this.state).sort().map(function (username) {
                return <Conversation username={username} log={this.state[username]} />;
              }.bind(this))}
            </div>
          );
        }
      });

      React.render(
        <div>
          <StaticTop />
          <Conversations />
        </div>,
        document.getElementById('content')
      );
    </script>
  </body>
</html>
